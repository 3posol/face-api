<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
  <script src="face-api.js"></script>
  <script src="commons.js"></script>
  <script src="FileSaver.js"></script>
  <script src="trainUtils.js"></script>
  <script src="train.js"></script>
  <script src="loss.js"></script>
</head>
<body>

  <script>
    tf = faceapi.tf

    const weightsUrl = '/tmp/test.weights'
    const fromEpoch = 800


    window.debug = true
    window.logTrainSteps = true


    // hyper parameters
    window.objectScale = 5
    window.noObjectScale = 1
    window.coordScale = 1

    window.saveEveryNthIteration = 50
    window.trainSteps = 4000
    //window.optimizer = tf.train.sgd(0.001)
    window.optimizer = tf.train.adam(0.001, 0.9, 0.999, 1e-8)

    const numTrainSamples = 1

    async function loadNetWeights(uri) {
      return new Float32Array(await (await fetch(uri)).arrayBuffer())
    }

    async function fetchDetectionFilenames() {
      return fetch('/detection_filenames').then(res => res.json())
    }

    async function run() {
      const weights = await loadNetWeights(weightsUrl)
      window.net = new faceapi.TinyYolov2(true)
      window.net.load(weights)
      window.net.variable()
      window.detectionFilenames = (await fetchDetectionFilenames()).slice(1, numTrainSamples + 1)
      window.lossMap = {}

      console.log('ready')
    }

    const trainSizes = [608]

    async function train(batchSize = 1) {
      for (let i = fromEpoch; i < trainSteps; i++) {
        log('step', i)
        let ts = Date.now()

        const batchCreators = createBatchCreators(shuffle(window.detectionFilenames), batchSize)

        for (let s = 0; s < trainSizes.length; s++) {
          let ts2 = Date.now()

          await trainStep(batchCreators, trainSizes[s])

          ts2 = Date.now() - ts2
          //log('train for size %s done (%s ms)', trainSizes[s], ts2)
        }

        ts = Date.now() - ts

        log()
        log('--------------------')
        log()
        log('step %s done (%s ms)', i, ts)

        const currentLoss = Object.keys(lossMap).map(k => lossMap[k]).reduce((sum, l) => sum + l)
        if (window.prevLoss) {
          log('prevLoss:', window.prevLoss)
          log('currentLoss:', currentLoss)
          log('loss change:', currentLoss - window.prevLoss)
        }
        log()
        log('--------------------')
        log()

        window.prevLoss = currentLoss


        if (((i + 1) % saveEveryNthIteration) === 0) {
          saveWeights(window.net, 'adam_511_' + i + '.weights')
        }
      }
    }

    run()

  </script>

</body>
</html>